#!/usr/bin/env bash

# T <command> [<stderr-pattern> [<stdout-pattern> [<message>]]]
# asserts <command> succeeds
# and that stderr matches <stderr-pattern>
# and that stdout matches <stdout-pattern>
# prints <message> with PASS or FAIL tag
T() {
	command=$1
	shift

	fd_dir=$(mktemp -d)

	if [ $# -gt 0 ]; then
		stderr_pattern=$1
		stderr_file=$fd_dir/stderr
		shift
	else
		stderr_pattern=""
		stderr_file=/dev/null
	fi

	if [ $# -gt 0 ]; then
		stdout_pattern=$1
		stdout_file=$fd_dir/stdout
		shift
	else
		stdout_pattern=""
		stdout_file=/dev/null
	fi

	if [ $# -gt 0 ]; then
		message=$1
		shift
	else
		message=$command
	fi

	printf "[      ] $message"

	eval "$command" 1>"$stdout_file" 2>"$stderr_file"
	exitcode=$?

	print_fail_message() { echo -e "\r[ \e[1;31mFAIL\e[1;0m ] $message" ; }

	print_stdout_and_stderr() {
		[ -s "$stdout_file" ] && echo -e "\e[1;33mstdout\e[1;0m:" 1>&2 && cat "$stdout_file" | sed 's/^\(.*\r\)*/\t/'
		[ -s "$stderr_file" ] && echo -e "\e[1;33mstderr\e[1;0m:" 1>&2 && cat "$stderr_file" | sed 's/^\(.*\r\)*/\t/' 1>&2
	}

	if [ $exitcode -ne 0 ]; then
		print_fail_message
		echo "Exit code of command '$command' was $exitcode"
		print_stdout_and_stderr
		rm -rf "$fd_dir"
		exit 1
	fi

	if [ ! -z "$stderr_pattern" ] && ! (cat "$stderr_file" | grep -q -- "$stderr_pattern") ; then
		print_fail_message
		echo "Standard error of command '$command' doesn't match pattern '$stderr_pattern'"
		print_stdout_and_stderr
		rm -rf "$fd_dir"
		exit 1

	fi

	if [ ! -z "$stdout_pattern" ] && ! (cat "$stdout_file" | grep -q -- "$stdout_pattern") ; then
		print_fail_message
		echo "Standard output of command '$command' doesn't match pattern '$stdout_pattern'"
		print_stdout_and_stderr
		rm -rf "$fd_dir"
		exit 1

	fi

	echo -e "\r[ \e[1;32mPASS\e[1;0m ] $message"
	rm -rf "$fd_dir"
}

# Asserts command fails
# See function T
F() {
	command="! ($1)"
	shift

	T "$command" "$@"
}

# BEGIN_TEST
BEGIN_TEST() {
	echo "[ #### ] Test script: $0"
	export starttime=$(date +%s.%N)
}

# END_TEST
END_TEST() {
	endtime=$(date +%s.%N)
	runtime=$(echo "$endtime - $starttime" | bc -l)
	echo "[ #### ] Total elapsed time: $runtime s"
}
